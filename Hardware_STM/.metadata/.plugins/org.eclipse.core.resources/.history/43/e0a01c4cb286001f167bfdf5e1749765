/*
 * test.c
 *
 *  Created on: Oct 10, 2024
 *      Author: AD
 */

#include "test.h"


void delay_us(uint16_t us){
	__HAL_TIM_SET_COUNTER(&htim6, 0);
	while(__HAL_TIM_GET_COUNTER(&htim6) < us);
}

void HAL_TIM_IC_CaptureCallback(TIM_HandleTypeDef* htim){
	if (htim == &htim1) {
		if (HAL_GPIO_ReadPin(GPIOE, GPIO_PIN_14) == GPIO_PIN_SET) {				// If pin on high, means positive edge
			tc1 = HAL_TIM_ReadCapturedValue(htim, TIM_CHANNEL_4);				// Retrieve value and store in tc1
		} else if (HAL_GPIO_ReadPin(GPIOE, GPIO_PIN_14) == GPIO_PIN_RESET) {	// If pin on low means negative edge
			tc2 = HAL_TIM_ReadCapturedValue(htim, TIM_CHANNEL_4);				// Retrieve value and store in tc2
			if (tc2 > tc1){
				echo = tc2 - tc1;		// Calculate the difference = width of pulse
			} else {
				echo = (65536 - tc1) + tc2;
			}
		}
	}
}
